{% extends "base.html" %}

{% block title %}Dashboard - WOLverine{% endblock %}

{% block content %}
<h1 class="mb-4 text-center">WOLverine Remote Control</h1>
<div class="row">
    <div class="col-md-4 mb-4">
        {% if session.role == 'admin' %}
        <a href="{{ url_for('add_host') }}" class="btn btn-success mb-3 float-start">➕ Add Host</a>
        {% endif %}
    </div>
</div>
<div class="row">
    {% for host in hosts %}
    {% set idx = host.id %}
        <div class="col-md-4 mb-4">
            <div class="host-card">
                <h3>{{ host.name }}</h3>
                <p>IP address: {{ host.ip }}</p>
                <p>Status: <span id="status-{{ idx }}">🔄 Checking...</span></p>

                {% if host.ssh_user %}
                <div class="d-flex gap-2">
                    <button onclick="performAction({{ idx }}, 'main')" id="btn-{{ idx }}" class="btn btn-primary">Loading...</button>
                    <button onclick="performAction({{ idx }}, 'reboot')" id="reboot-{{ idx }}" class="btn btn-warning d-none">🔁 Reboot</button>
                    <button onclick="performAction({{ idx }}, 'wake')" id="wake-{{ idx }}" class="btn btn-success d-none">💤 Wake up</button>
                </div>
                {% endif %}

                <pre id="info-{{ idx }}"></pre>
                {% if session.role == 'admin' %}
                <div class="d-flex gap-2 mt-2">
                    <a href="{{ url_for('edit_host', host_id=host.id) }}" class="btn btn-warning">✏️ Edit</a>
                    <form method="POST" action="{{ url_for('delete_host', host_id=host.id) }}" onsubmit="return confirm('Delete host {{ host.name }}?');">
                        <button type="submit" class="btn btn-danger">🗑️ Delete</button>
                    </form>
                </div>
                {% endif %}
            </div>
    </div>
    {% endfor %}
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>
<script>
const socket = io.connect("http://localhost:5000");

socket.on('status_update', (data) => {
    console.log("Status update received:", data);
    document.getElementById(`status-${data.idx}`).textContent = data.online ? '🟢 Online' : '🔴 Offline';

    if (data.has_ssh) {
        const mainBtn = document.getElementById(`btn-${data.idx}`);
        const rebootBtn = document.getElementById(`reboot-${data.idx}`);
        const wakeBtn = document.getElementById(`wake-${data.idx}`);
        if (mainBtn) mainBtn.textContent = data.online ? '🛑 Shutdown' : '💤 Wake up';
        if (rebootBtn) rebootBtn.classList.toggle("d-none", !data.online);
        if (wakeBtn) wakeBtn.classList.toggle("d-none", data.online);
    }

    document.getElementById(`info-${data.idx}`).textContent = data.info;
});

async function performAction(i, type = 'main') {
    // Show the loading overlay
    document.getElementById("loading-overlay").style.display = "flex";

    let action = type === 'reboot' ? 'reboot' : type === 'wake' ? 'wake' : null;

    if (!action) {
        const label = document.getElementById(`btn-${i}`).textContent;
        action = label.includes("🛑") ? "shutdown" : "wake";
    }

    const res = await fetch(`/action/${i}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action })
    });

    console.log("Response status:", res.status);

    const result = await res.json();
    console.log("Response data:", result);

    // Hide the loading overlay after 4 seconds or when response is received
    setTimeout(() => {
        document.getElementById("loading-overlay").style.display = "none";
    }, 4000);

    setTimeout(() => fetchStatus(i), 4000);
}

async function fetchStatus(i) {
    const res = await fetch(`/status/${i}`);
    const data = await res.json();

    document.getElementById(`status-${i}`).textContent = data.online ? '🟢 Online' : '🔴 Offline';
    document.getElementById(`btn-${i}`).textContent = data.online ? '🛑 Shutdown' : '💤 Wake up';
    
    const rebootBtn = document.getElementById(`reboot-${i}`);
    if (rebootBtn) {
        rebootBtn.classList.toggle("d-none", !data.online);
    }

    const wakeBtn = document.getElementById(`wake-${i}`);
    if (wakeBtn) {
        wakeBtn.classList.toggle("d-none", data.online);
    }

    document.getElementById(`info-${i}`).textContent = data.info;
}

const hostIds = [ {% for host in hosts %}{{ host.id }}, {% endfor %} ];
    
function refreshAll() {
    for (let i = 0; i < hostIds.length; i++) {
        fetchStatus(hostIds[i]);
    }
}

refreshAll();
setInterval(refreshAll, 10000);
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
{% endblock %}
